# E2E Tests

End-to-end tests for the Management Console (mcctl-api + mcctl-console) using Playwright.

## Overview

These tests verify the complete user journey through the web console, including:
- Authentication (login/logout)
- Dashboard functionality
- Server management
- API endpoints

## Prerequisites

1. **Node.js 20+** and **pnpm** installed
2. **PM2** installed globally (or as a dev dependency)
3. **Services built**: Run `pnpm build` from the project root

## Quick Start

```bash
# From project root
pnpm install
pnpm build

# Install PM2 if not already installed
npm install -g pm2

# Initialize console service (generates ecosystem.config.cjs)
mcctl console init

# Run tests
cd e2e
pnpm test
```

## Test Scripts

| Script | Description |
|--------|-------------|
| `pnpm test` | Run all tests (auto-starts PM2 services) |
| `pnpm test:ui` | Open Playwright UI for interactive testing |
| `pnpm test:headed` | Run tests in headed browser mode |
| `pnpm test:debug` | Run tests in debug mode |
| `pnpm test:ci` | Run tests and stop services after (for CI) |
| `pnpm test:skip-start` | Skip service auto-start (use existing services) |
| `pnpm report` | View the HTML test report |

## Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `E2E_BASE_URL` | `http://localhost:5000` | Console URL |
| `E2E_API_URL` | `http://localhost:5001` | API URL |
| `E2E_SKIP_SERVICE_START` | `false` | Skip PM2 service startup |
| `E2E_STOP_SERVICES` | `false` | Stop services after tests |

## Service Management

### Via PM2 (Recommended)

Services are managed via PM2 using the `ecosystem.config.cjs` generated by `mcctl console init`.

```bash
# Start services manually
cd platform
pm2 start ecosystem.config.cjs

# View logs
pm2 logs

# Check status
pm2 status

# Stop services
pm2 stop all
```

### Test Behavior

1. **Auto-start**: Tests automatically start services via PM2 if not running
2. **Keep running**: Services stay running after tests for faster subsequent runs
3. **CI mode**: Use `pnpm test:ci` to stop services after tests complete

## Test Structure

```
e2e/
├── fixtures/
│   ├── auth.ts                         # Authentication fixtures and helpers
│   └── config-snapshot-helpers.ts      # Config Snapshot test utilities
├── tests/
│   ├── auth.spec.ts                    # Authentication tests
│   ├── api.spec.ts                     # API endpoint tests
│   ├── api-backup.spec.ts              # Backup API tests
│   ├── api-health.spec.ts              # Health & system API tests
│   ├── api-integration.spec.ts         # Cross-resource integration tests
│   ├── api-players.spec.ts             # Player management API tests
│   ├── api-router.spec.ts              # mc-router API tests
│   ├── api-servers.spec.ts             # Server management API tests
│   ├── api-worlds.spec.ts              # World management API tests
│   ├── dashboard.spec.ts               # Dashboard tests
│   ├── servers.spec.ts                 # Server management UI tests
│   ├── sse.spec.ts                     # Server-Sent Events tests
│   └── config-snapshot/                # Config Snapshot feature tests
│       ├── config-snapshot-api.spec.ts # API integration tests (CRUD, diff, restore, schedules)
│       ├── config-snapshot-web.spec.ts # Web Console UI tests (Playwright)
│       └── config-snapshot-cli.spec.ts # CLI scenario tests
├── global-setup.ts      # Starts PM2 services before tests
├── global-teardown.ts   # Optional cleanup after tests
├── playwright.config.ts # Playwright configuration
└── README.md            # This file
```

## Writing Tests

### Using Authentication Fixture

```typescript
import { test, expect } from '../fixtures/auth';

test('authenticated test', async ({ authenticatedPage }) => {
  // authenticatedPage is already logged in
  await authenticatedPage.goto('/dashboard');
  await expect(authenticatedPage).not.toHaveURL(/\/login/);
});
```

### Testing API Endpoints

```typescript
import { test, expect } from '@playwright/test';

const API_URL = process.env.E2E_API_URL || 'http://localhost:5001';

test('health check', async ({ request }) => {
  const response = await request.get(`${API_URL}/health`);
  expect(response.status()).toBe(200);
});
```

### Using Config Snapshot Helpers

```typescript
import { test, expect } from '@playwright/test';
import {
  createConfigSnapshotViaApi,
  cleanupSnapshots,
  getFirstServerName,
} from '../fixtures/config-snapshot-helpers';

test('snapshot lifecycle', async () => {
  const serverName = await getFirstServerName();
  if (!serverName) { test.skip(); return; }

  const createdIds: string[] = [];
  try {
    const snap = await createConfigSnapshotViaApi(serverName, 'my snapshot');
    if (snap) {
      createdIds.push(snap.id);
      expect(snap.serverName).toBe(serverName);
    }
  } finally {
    await cleanupSnapshots(serverName, createdIds);
  }
});
```

## Debugging

### View Test Report

```bash
pnpm report
```

### Run Single Test

```bash
pnpm exec playwright test auth.spec.ts
pnpm exec playwright test -g "should login"
```

### Debug Mode

```bash
pnpm test:debug
```

### View PM2 Logs

```bash
pm2 logs mcctl-api
pm2 logs mcctl-console
```

## CI/CD

Tests run automatically on:
- Push to `main` or `develop`
- Pull requests to `main` or `develop`

The GitHub Actions workflow:
1. Builds all packages
2. Installs PM2 and Playwright
3. Generates ecosystem config
4. Starts services via PM2
5. Runs tests
6. Uploads test reports on failure

## Troubleshooting

### Services won't start

1. Check if ports 5000/5001 are available
2. Verify `mcctl console init` was run
3. Check PM2 logs: `pm2 logs`

### Tests timeout waiting for services

1. Increase timeout in `global-setup.ts`
2. Check service logs for errors
3. Verify services are built: `pnpm build`

### Authentication tests fail

1. Ensure default credentials (admin/admin) work
2. Check if `users.yaml` exists in platform directory
3. Verify API is responding: `curl http://localhost:5001/health`

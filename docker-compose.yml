# =============================================================================
# Multi-Server Minecraft Docker Compose Configuration
# =============================================================================
# Architecture:
#   - mc-router: Connection router with auto-scale support (hostname-based)
#   - MC Servers: Each server in its own directory under servers/
#
# Adding a new server:
#   1. Copy template: cp -r servers/_template servers/my-server-name
#   2. Edit servers/my-server-name/docker-compose.yml (service name, container, labels)
#   3. Edit servers/my-server-name/config.env (server settings)
#   4. Add include below: - servers/my-server-name/docker-compose.yml
#   5. Add MAPPING entry: my-server-name.local=mc-my-server-name:25565
#   6. Run: docker compose up -d
#
# Connection (requires hosts file or DNS):
#   Add to /etc/hosts: <server-ip> survival.local creative.local modded.local
# =============================================================================

# -----------------------------------------------------------------------------
# Include server configurations
# -----------------------------------------------------------------------------
include:
  - servers/survival/docker-compose.yml
  - servers/creative/docker-compose.yml
  - servers/modded/docker-compose.yml

# -----------------------------------------------------------------------------
# Services
# -----------------------------------------------------------------------------
services:
  # ===========================================================================
  # MC Router - Connection Router with Auto-Scale
  # ===========================================================================
  router:
    image: itzg/mc-router
    container_name: mc-router
    restart: unless-stopped
    command: >
      --in-docker
      --auto-scale-up
      --auto-scale-down
      --auto-scale-down-after=10m
      --docker-timeout=120
      --auto-scale-asleep-motd=§e서버가 시작 중입니다... 잠시만 기다려주세요!
    ports:
      - "25565:25565"
    environment:
      # =========================================================================
      # Server Mappings - Add new servers here
      # =========================================================================
      # Format: hostname=container:port
      # The hostname must match mc-router.host label in server's docker-compose.yml
      MAPPING: |
        survival.local=mc-survival:25565
        creative.local=mc-creative:25565
        modded.local=mc-modded:25565
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - minecraft-net
    depends_on:
      - mc-survival
      - mc-creative
      - mc-modded

# -----------------------------------------------------------------------------
# Networks
# -----------------------------------------------------------------------------
networks:
  minecraft-net:
    name: ${MINECRAFT_NETWORK:-minecraft-net}
    driver: bridge
    ipam:
      config:
        - subnet: ${MINECRAFT_SUBNET:-172.28.0.0/16}

# =============================================================================
# Multi-Server Minecraft Docker Compose Configuration
# =============================================================================
# Architecture:
#   - mc-router: Connection router with auto-scale support
#   - MC Servers: Started on-demand, stopped when idle
# =============================================================================

# Common Minecraft server configuration (YAML anchor)
x-minecraft-common: &minecraft-common
  image: itzg/minecraft-server:java21
  restart: "no"  # mc-router controls lifecycle
  tty: true
  stdin_open: true
  environment:
    EULA: "TRUE"
    TZ: ${TZ:-Asia/Seoul}
    ENABLE_RCON: "true"
    RCON_PASSWORD: ${RCON_PASSWORD:-changeme}
  networks:
    - minecraft-net

services:
  # ===========================================================================
  # MC Router - Connection Router with Auto-Scale
  # ===========================================================================
  router:
    image: itzg/mc-router
    container_name: mc-router
    restart: unless-stopped
    command: >
      --in-docker
      --auto-scale-up
      --auto-scale-down
      --auto-scale-down-after=10m
      --docker-timeout=120
      --auto-scale-asleep-motd=§e서버가 시작 중입니다... 잠시만 기다려주세요!
    ports:
      - "25565:25565"  # All servers via hostname routing
    environment:
      # Static mapping (hostname=backend:port)
      # Clients connect with: survival.local, creative.local, modded.local
      MAPPING: |
        survival.local=mc-survival:25565
        creative.local=mc-creative:25565
        modded.local=mc-modded:25565
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - minecraft-net
    depends_on:
      - mc-survival
      - mc-creative
      - mc-modded

  # ===========================================================================
  # Minecraft Servers
  # ===========================================================================

  # ---------------------------------------------------------------------------
  # Survival Server (PAPER)
  # ---------------------------------------------------------------------------
  mc-survival:
    <<: *minecraft-common
    container_name: mc-survival
    env_file:
      - .env
      - servers/survival/config.env
    volumes:
      - ./servers/survival/data:/data
      - ./servers/survival/logs:/data/logs
      - ./worlds:/worlds:rw
      - ./shared/plugins:/plugins:ro
    labels:
      - "mc-router.host=survival.local"
      - "mc-router.auto-scale-up=true"
      - "mc-router.auto-scale-down=true"

  # ---------------------------------------------------------------------------
  # Creative Server (VANILLA)
  # ---------------------------------------------------------------------------
  mc-creative:
    <<: *minecraft-common
    container_name: mc-creative
    env_file:
      - .env
      - servers/creative/config.env
    volumes:
      - ./servers/creative/data:/data
      - ./servers/creative/logs:/data/logs
      - ./worlds:/worlds:rw
      - ./shared/plugins:/plugins:ro
    labels:
      - "mc-router.host=creative.local"
      - "mc-router.auto-scale-up=true"
      - "mc-router.auto-scale-down=true"

  # ---------------------------------------------------------------------------
  # Modded Server (FORGE)
  # ---------------------------------------------------------------------------
  mc-modded:
    <<: *minecraft-common
    container_name: mc-modded
    env_file:
      - .env
      - servers/modded/config.env
    volumes:
      - ./servers/modded/data:/data
      - ./servers/modded/logs:/data/logs
      - ./worlds:/worlds:rw
      - ./shared/mods:/mods:ro
    labels:
      - "mc-router.host=modded.local"
      - "mc-router.auto-scale-up=true"
      - "mc-router.auto-scale-down=true"

# =============================================================================
# Networks
# =============================================================================
networks:
  minecraft-net:
    name: ${MINECRAFT_NETWORK:-minecraft-net}
    driver: bridge
    ipam:
      config:
        - subnet: ${MINECRAFT_SUBNET:-172.20.0.0/16}
